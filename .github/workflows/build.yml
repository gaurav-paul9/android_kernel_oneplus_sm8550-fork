name: Build OnePlus 12R (ASTON) Kernel

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout kernel source
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y bc bison build-essential ccache curl flex git g++ \
          gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi libssl-dev \
          libncurses5-dev libncursesw5-dev python3 device-tree-compiler zip

    - name: Clone Proton Clang
      run: |
        git clone --depth=1 https://github.com/kdrag0n/proton-clang clang

    - name: Setup environment
      run: |
        export PATH=$PWD/clang/bin:$PATH
        echo "Using clang:"
        clang --version

    - name: Build final defconfig (stacked configs)
      run: |
        export ARCH=arm64
        export SUBARCH=arm64
        export O=out
        export PATH=$PWD/clang/bin:$PATH

        mkdir -p out

        # 1. Base GKI
        make O=$O ARCH=arm64 gki_defconfig

        # 2. Merge vendor fragments
        bash scripts/kconfig/merge_config.sh -m \
          out/.config \
          arch/arm64/configs/vendor/kalama_GKI.config \
          arch/arm64/configs/vendor/oplus/kalama_GKI.config \
          arch/arm64/configs/vendor/debugfs.config

        # 3. Finalize
        make O=$O ARCH=arm64 olddefconfig

    - name: Build Kernel
      run: |
        export ARCH=arm64
        export SUBARCH=arm64
        export O=out
        export PATH=$PWD/clang/bin:$PATH

        export CC=clang
        export LD=ld.lld
        export AR=llvm-ar
        export NM=llvm-nm
        export OBJCOPY=llvm-objcopy
        export OBJDUMP=llvm-objdump
        export STRIP=llvm-strip

        export HOSTCC=gcc
        export HOSTCXX=g++
        export HOSTLD=ld

        export CROSS_COMPILE=aarch64-linux-gnu-
        export CROSS_COMPILE_ARM32=arm-linux-gnueabi-

        make -j$(nproc) O=$O ARCH=arm64 LLVM=1

    - name: Build dtbs
      run: |
        make -j$(nproc) O=out ARCH=arm64 dtbs || true

    - name: Create Image.gz-dtb
      run: |
        BOOT=out/arch/arm64/boot

        if [ ! -f $BOOT/Image.gz ]; then
          gzip -c $BOOT/Image > $BOOT/Image.gz
        fi

        DTB=$(find out/arch/arm64/boot/dts -name "*kalama*.dtb" | head -n1)
        echo "Using DTB: $DTB"

        cat $BOOT/Image.gz $DTB > $BOOT/Image.gz-dtb

    - name: Clone AnyKernel3
      run: |
        git clone --depth=1 https://github.com/osm0sis/AnyKernel3 AnyKernel3

    - name: Package flashable zip
      run: |
        BOOT=out/arch/arm64/boot
        cp $BOOT/Image.gz-dtb AnyKernel3/
        cd AnyKernel3
        zip -r9 ../OnePlus12R-Kernel.zip ./*

    - name: Create Release & Upload Zip
      uses: softprops/action-gh-release@v1
      with:
        tag_name: "build-${{ github.run_id }}"
        name: "OnePlus 12R Kernel Build"
        files: OnePlus12R-Kernel.zip
